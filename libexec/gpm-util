-- Load globally installed packages
local argparse = assert(require "argparse")

-- Load local packages
local exception  = assert(require "lib.exception")
local path       = assert(require "lib.path")
local version    = assert(require "lib.version")
local util       = assert(require "lib.util")
local logging    = assert(require "lib.logging")
local ansicolor  = assert(require "lib.ansicolor")
local configload = assert(require "lib.configload")
local filesystem = assert(require "lib.filesystem")
local database   = assert(require "lib.database")
local lmod       = assert(require "lib.lmod")
local hwdetect   = assert(require "lib.hwdetect.hwdetect")

-- Description of this script
local description = version.get_description("gpm-util")

--
local function command_lmod(args, logs)
   if args.update_cache then
      lmod.update_lmod_cache(logs)
   end
end

--- Main driver.
function main()
   -- Arg parser
   local parser = argparse(description.script_name, description.name .. ":\n" .. description.desc)
   
   -- Commands
   local parser_lmod = parser:command("lmod", "Manipulate Lmod.") 
   
   -- Some general arguments
   parser:option("-c --config", "Provide config file."):overwrite(false)
   parser:option("-t --token"   , "Set a stack token."):overwrite(false)
   parser:flag("--debug", "Print debug information (mostly for developers).")
   parser:flag("-v --version", "Print '" .. version.get_version() .. "' and exit."):action(function()
      print(version.get_version())
      os.exit(0)
   end)
   
   -- arch specific
   --parser_arch:flag("-a --all"   , "List all available stacks."):overwrite(false)
   
   -- lmod specific
   parser_lmod:flag  ("--update-cache",   "Update Lmod cache for current stack.")
      
   -- Parse arguments
   args = parser:parse()
   
   if args.debug then
      logging.debug("Lua version : " .. _VERSION, io.stdout)
      logging.debug(util.print(args, "args"), io.stdout)
   end
   
   local logs = {io.stdout}
   
   exception.try(function()
      -- Bootstrap config
      configload.bootstrap(nil, args, {}, true)

      if args.lmod then
         command_lmod(args, logs)
      end
   end, function(e)
      -- Print exception
      exception.message(e)
         
      -- Print usage
      print("\n" .. parser:get_usage())

      -- Exit with non zero status
      os.exit(1)
   end)
end

--[[
# vi:syntax=lua
--]]
